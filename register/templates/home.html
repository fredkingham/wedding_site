{% load staticfiles %}
{% extends 'base.html' %}
{% block contents %}
  <div id="vue-container" class="ui inverted vertical masthead center aligned segment wedding-container">
    <div v-bind:class="{loading : person.saving || (person.plusOne && person.plusOne.saving) ||  person.saved || (person.plusOne && person.plusOne.saved)}" class="loading-space">
      <div>
        <div v-if="person.saving || (person.plusOne && person.plusOne.saving)" class="ui active inverted loader"></div>
        <div v-if="person.saved || (person.plusOne && person.plusOne.saved)" style="margin-top: -21px; color: white;">
          <p style="font-size: 30px;">
            &#10003;
          </p>
          saved
        </div>
      </div>
    </div>
    <div class="top-bar" v-if="person.visited">
      <h1 class="ui inverted header main-header">
        Fred and Christina's wedding
      </h1>
      <h1 class="ui inverted header main-header2">
        1 September 2018, <a href="https://www.google.co.uk/maps/place/Chiswick+Town+Hall/@51.4911405,-0.2654384,15z/data=!4m5!3m4!1s0x0:0xd6b93df3f57a61b4!8m2!3d51.4911405!4d-0.2654384">Chiswick Town Hall</a>
      </h1>
    </div>
    <div v-if="!person.visited">
      <landing-page v-bind:person="person"></landing-page>
    </div>
    <div v-if="person.visited" class="ui container">
      <div class="ui grid stackable">
        <div class="row">
          <div class="column one wide"></div>
          <div class="column six wide">
            <img class="second-page" src="{% static "img/fred-kisses-ck.jpeg" %}" />
          </div>
          <person-form v-bind:person="person"></person-form>
        </div>
        <div v-if="person.showOther" class="row">
          <div class="column one wide"></div>
          <person-form v-bind:person="person.plusOne"></person-form>
          <div class="column six wide">
            <img class="second-page" src="{% static "img/fred-kisses-ck.jpeg" %}" />
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="text/x-template" id="person-form">
    {% include "partials/person_form.html" %}
  </script>

  <script type="text/x-template" id="landing-page">
    <div>
      <div class="ui container">
        <h1 class="ui inverted header main-header">
          Fred and Christina's wedding
        </h1>
        <h1 class="ui inverted header main-header2">
          1 September 2018, <a href="https://www.google.co.uk/maps/place/Chiswick+Town+Hall/@51.4911405,-0.2654384,15z/data=!4m5!3m4!1s0x0:0xd6b93df3f57a61b4!8m2!3d51.4911405!4d-0.2654384">Chiswick Town Hall</a>
        </h1>
        <img class="main-img" src="{% static "img/ck_and_fk.jpg" %}" />
      </div>
      <div class="button-container">
        <button v-on:click="person.set('rsvpChoice', RSVP_CHOICES.YES)" class="ui grey left huge basic button fixed button-container">I would love to come</button>
      </div>
      <div class="button-container">
        <button v-on:click="person.set('rsvpChoice', RSVP_CHOICES.NO)" class="right grey huge basic ui button fixed button-container">Sorry, I can't make it</button>
      </div>
    </div>
  </script>


  <script>
    !(function(){
      "use strict";

      // using jQuery
      function getCookie(name) {
          var cookieValue = null;
          if (document.cookie && document.cookie !== '') {
              var cookies = document.cookie.split(';');
              for (var i = 0; i < cookies.length; i++) {
                  var cookie = jQuery.trim(cookies[i]);
                  // Does this cookie string begin with the name we want?
                  if (cookie.substring(0, name.length + 1) === (name + '=')) {
                      cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                      break;
                  }
              }
          }
          return cookieValue;
      }
      var csrftoken = getCookie('csrftoken');

      function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
      }

      $.ajaxSetup({
          beforeSend: function(xhr, settings) {
              if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                  xhr.setRequestHeader("X-CSRFToken", csrftoken);
              }
          }
      });

      var CONSTANTS = {
        RSVP_CHOICES: {
          YES: true,
          NO: false
        },
        FOOD_CHOICES: {
          PIG: "pig",
          VEGGIE: "veggie",
          OTHER: "other"
        },
        STATE_CHOICES: {
          LANDING: "landing",
          FOOD: "Food",
          SONG: "Song",
          NOPE: "Nope",
          INVITE_OTHER: "Invite Other",
          OTHER_PERSON: "Other Person"
        }
      }

      var Person = function(someJson){
        this.id = someJson.id;
        this.visited = someJson.visited;
        this.foodChoice = someJson.food_choice;
        this.rsvpChoice = someJson.rsvp_choice;
        this.favouriteSong = someJson.favouriteSong;
        this.foodPreferenceOther = someJson.food_Preference_other || "";
        this.songChoice = someJson.song_choice || "";
        this.user = someJson.user;
        this.showOther = false;
        this.saving = false;
        this.saved = false;
        if(someJson.plus_one){
          this.plusOne = new Person(someJson.plus_one);
        }
        else{
          this.plusOne = null;
        }
      }

      Person.prototype = {
        rsvp: function(rsvpChoice){
          this.state = "Food";
          this.rsvpChoice = rsvpChoice;
          this.save();
        },
        save: function(){
          var data = {
            visited: this.visited,
            food_choice: this.foodChoice,
            rsvp_choice: this.rsvpChoice,
            favourite_song: this.favouriteSong,
            song_choice: this.songChoice,
            food_Preference_other: this.foodPreferenceOther
          }
          this.saving = true;
          var self = this;
          $.ajax({
            url: '/api/invitationdetails/' + self.id + "/",
            type: 'PUT',
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            data: JSON.stringify(data),
            success: function(data) {
              self.saving = false;
              self.saved = true;
              setTimeout(function(){
                self.saved = false;
              }, 2000)
            }
          });
        },
        changeState: function(){
          if(this.rsvpChoice === null){
            this.state = CONSTANTS.STATE_CHOICES.LANDING;
          }
          else if(!this.foodChoice){
            this.state = CONSTANTS.STATE_CHOICES.FOOD;
          }
          else if(!this.songChoice || !this.songChoice.length){
            this.state = CONSTANTS.STATE_CHOICES
          }
        },
        set: function(someField, someValue){
          this[someField] = someValue;
          this.visited = true;
          this.save();
        }
      }

      Vue.component('landing-page', {
        props: ['person'],
        delimiters: ['[[', ']]'],
        template: '#landing-page',
        data: function(){
          return CONSTANTS
        }
      });

      Vue.component('person-form', {
        // The todo-item component now accepts a
        // "prop", which is like a custom attribute.
        // This prop is called todo.
        props: ['person'],
        delimiters: ['[[', ']]'],
        template: '#person-form',
        data: function(){
          return CONSTANTS
        }
      })

      new Vue({
        el: '#vue-container',
        delimiters: ['[[', ']]'],
        data: function(){
          var constants = JSON.parse(JSON.stringify(CONSTANTS));
          constants.person = new Person({{ details | safe }});
          return constants;
        }
      });
    })();
  </script>
{% endblock %}
